{% extends 'base.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('date-picker/css/bootstrap-datepicker.css') }}">
    <link rel="stylesheet" href="{{ asset('css/stripe.css') }}">
{% endblock %}
{% block body %}
    <div id="content" style="display:none">
        <div class="container" style="background:#f5f5f5">
            <div class="row" style="margin-top:30px; margin-bottom:30px;">
                <ul id="breadcrumbs">
                    <li class="etape1 temp1" id="#etape_reservation"><center><span class="Mycircle">1</span> Détails de la réservation</center></li>
                    <li class="etape2 temp2" id="#etape_billet"> <center><span class="Mycircle">2</span> Renseignements sur le(s) billet(s)</center></li>
                    <li class="etape3 temp3" id="#etape_paiement" style="width: 369px !important;"> <center><span class="Mycircle">3</span> Paiement</center></li>
                </ul>
            </div>
            <div id="loading_bar" style="display: none; margin: 294px 895px; position: absolute; z-index: 500;">
                <img class="img-circle img-responsive" width="20px"
                     src="{{ asset('images/loading_pr2.gif') }}">
            </div>
            <form action="{{ path('get_info') }}" method="POST" id="payment-form">
                <div class="payment-errors"></div>
                <div class="row">
                    <div class="col-md-12">
                        {% include('ReservationBundle:SinglePage:reservation-form.html.twig') %}
                        <div class="row">
                            {% include('ReservationBundle:SinglePage:billet-form.html.twig') %}
                        </div>
                        {% include('ReservationBundle:SinglePage:stripe-form.html.twig') %}
                    </div>
                </div>
                <div id="validate_all" class="button-wrapper" style="margin-left: 52%; display: none;">
                    <button class="a-btn" style="margin-left: -9px;">
                        <span class="a-btn-text">Validez votre reservation</span>
                        <span class="a-btn-slide-text">Votre billet sera envoyé par mail</span>
                        <span id="loading_pay" style="display: none; margin: -34px 276px; position: absolute; z-index: 150;">
                            <img class="img-circle img-responsive" width="20px" src="{{ asset('images/loading_pr2.gif') }}">
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('date-picker/js/bootstrap-datepicker.min.js') }}"></script>
    <script src="{{ asset('date-picker/locales/bootstrap-datepicker.fr.min.js') }}"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript">
        $(document).on("click", "#acheterBtn", function () {
            $("#header_nav").fadeIn(1000).css("display", "none");
            $('#content').fadeIn(1000).css("display", "block");
        });
        $('#loadingBtn').click(function (e) {
            $("#loading_bar").fadeIn(1000).css("display", "block");
        });
        $('#loadingcacher').click(function (e) {
            $("#loading_bar").fadeIn(1000).css("display", "none");
        });
    </script>

    <!-- script pour la partie reservation -->
    <script type="text/javascript">
        var now = new Date();
        var disabled_dates_param = "{{ container.parameter('date_fermetures')|join(',') }}";
        var disabled_dates = disabled_dates_param.split(',');

        $('#date_visite').datepicker({
            autoclose: true,
            startDate: "today",
            endDate: "+120d",
            daysOfWeekDisabled: "2",
            format: "dd-mm-yyyy",
            todayHighlight: true,
            language: 'fr',
            orientation: "bottom",
            beforeShowDay: function (date) {
                var dt_ddmm = date.getDate() + '-' + (date.getMonth() + 1);
                return (disabled_dates.indexOf(dt_ddmm) == -1);
            }
        }).on('changeDate', function (e) {
            $('#etapeSuivant').attr("disabled", false);
            $('#error_date_reservation').css('display','none').html('');
            var fullDate = dateFr(e.date);
            var selectedDate = new Date(e.date);
            var sectedDateFormated = getFormattedDate(selectedDate);
            $('#date_reservation_formated').val(sectedDateFormated);
            $('#my_hidden_input').val(fullDate);

            var current_hour = new Date();
            var date_res = $('#date_reservation_formated').val();
            var date_now = getFormattedDate(now);
            if(date_now == date_res && current_hour.getHours() > 13){
                $('#journee_type').attr('disabled',true);
            }else{
                $('#journee_type').attr('disabled',false);
            }
        });

        $("#nb_billet").keyup(function () {
            $('#validation').html('');
            $('#etapeSuivant').attr("disabled", false);
        });

        $('select[name="type_billet"]').click(function(){
            $('#type_billet').html('');
        });

        function getFormattedDate(date) {
            var year = date.getFullYear();

            var month = (1 + date.getMonth()).toString();
            month = month.length > 1 ? month : '0' + month;

            var day = date.getDate().toString();
            day = day.length > 1 ? day : '0' + day;

            return year + '-' + month + '-' + day;
        }
        //function pour faire la date en français
        function dateFr(date) {
            var mois = new Array("janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "decembre");
            // on recupere la date
            var date = new Date(date);
            // on construit le message
            var message = date.getDate() + " ";   // numero du jour
            message += mois[date.getMonth()] + " ";   // mois
            message += date.getFullYear();
            return message;
        }
    </script>

    <!-- script pour la partie billet -->
    <script type="text/javascript">

        $('#validation').html('');
        $('#etapeSuivant').click(function (e) {
            e.preventDefault();

            $('#etapeSuivant').attr("disabled", true);

            var nombre_billet = $('#nb_billet').val();
            var date_reservation_val = $('#date_reservation_formated').val();
            var type_billet = $('select[name="type_billet"]').val();
            var valid_billet = getErrorBillet(nombre_billet);
            if (valid_billet == true && type_billet != '' && date_reservation_val != '') {
                $('#etape_reservation').removeAttr('class').attr('class', '');

                $("#loading_bar").fadeIn(1000).css("display", "block");
                var sectedDateFormated = $('#date_reservation_formated').val();
                $.ajax({
                    type: "GET",
                    url: 'verif-date-reservation',
                    data: {date: sectedDateFormated},
                    success: function (data) {
                        if (data.content.message != "disponible") {
                            $('#error_date_reservation').css('display', 'block').html('Date non disponible veuillez séléctionnez un autre date');
                            $('#etapeSuivant').attr("disabled", true);
                        } else {
                            $('#error_date_reservation').css('display', 'none').html('');
                            $('#etapeSuivant').attr("disabled", false);

                            localStorage.setItem('_nbr', nombre_billet);
                            $('#reservation_info').fadeIn(1000).css("display", "none");
                            $("#billet").fadeOut(1000).css("display", "block");
                            $("#tarrifs_details").fadeOut(1000).css("display", "block");

                            for (var i = 1; i <= nombre_billet; i++) {
                                $('#billet').append('<span class="text-center" > Billet ' + i + '</span>' +
                                '<div style="border: solid 1px; padding: 10px ;">' +
                                '<div class="row form-group">' +
                                '<input type="hidden" value="0" id="montant' + i + '" name="montant' + i + '"><input type="hidden" id="motif' + i + '" name="motif' + i + '">' +
                                createTag(i, "nom", "Nom", "validate form-control") + createTag(i, "prenom", "Prenom", "validate form-control") +
                                '</div>' +
                                '<div class="row">' +
                                '<div class="col-sm-6">' +
                                '<p style="display: none; font-size: 14px; margin-left: 5px;" id="reduit' + i + '">il sera nécessaire de présenter votre carte d’étudiant, militaire ou équivalent lors de l’entrée</p>' +
                                '<p id="nonreduit' + i + '"><input type="text" class="datepickerbirth form-control" name="datenaissance' + i + '" id="' + i + '" placeholder="Date de naissance" autocomplete="off" readonly></p>' +
                                '<em class="error-field obligatoiretarif' + i + '"></em>'+
                                '</div>' +
                                createTag(i, "pays", "Pays", "validate recherche form-control") +
                                '</div>' +
                                '<div class="row">' +
                                '<div class="col-sm-12"><input type="checkbox" name="tarif_reduit' + i + '" id="' + i + '"> <span style="margin-left: 10px;">Je bénéficie d\'un tarif réduit</span></div>' +
                                '</div>' +
                                '</div>');

                                $('#tarif #tarif_content').append(
                                        '<div style="display: none;" class="numbillet' + i + ' col-sm-4"></div>' +
                                        '<div style="display: none;" class="tarif' + i + ' col-sm-4"></div>' +
                                        '<div style="display: none;" class="montant' + i + ' col-sm-4"></div>'
                                )
                            }
                        }
                    }
                }).done(function () {
                    $("#loading_bar").fadeOut(2000).css("display", "none");
                });
            } else if(valid_billet == true && type_billet != '' && date_reservation_val == '') {
                $('#error_date_reservation').css('display','block').html('Veuillez choisir votre date de résérvation');
            } else if(valid_billet == true && type_billet == '' && date_reservation_val != '') {
                $('#type_billet').html('Veuillez choisir le type de votre billet');
            } else if(valid_billet != true && date_reservation_val != '' && type_billet != '') {
                $('#validation').html(valid_billet);
            } else {
                $('#validation').html(valid_billet);
                $('#error_date_reservation').css('display','block').html('Veuillez choisir votre date de résérvation');
                $('#type_billet').html('Veuillez choisir le type de votre billet');
            }
            $('#date_reservation').html($('#my_hidden_input').val());
        });
        function createTag(index, name, placeholder, my_class) {
            var html = '';
            html += '<div class="col-sm-6"><input type="text" class="' + my_class + '" name="' + name + index + '" id="' + index + '" placeholder="' + placeholder + '" required> <br><em class="error-field obligatoire' + name + index + '"></em></div>';
            return html;
        }

        function getErrorBillet(nombre_billet){
            if(nombre_billet != undefined && nombre_billet != '') {
                if ($.isNumeric(nombre_billet) && nombre_billet > 0) {
                    return true;
                }else{
                    return 'Valeur non valide';
                }
            }else{
                return 'Veuillez entrez le nombre de billet';
            }
        }

        function getTotal(nb) {
            var total = 0;
            for (var i = 1; i <= nb; i++) {
                total += parseInt($('#montant' + i).val());
            }
            return total;
        }

        function dateDiff(dob, id) {
            if (dob == 'reduit') {
                var montant = 10;
                var tarif = 'reduit';
                //append tarif value
                $('#montant' + id).val(montant);
                $('#motif' + id).val(tarif);
                $('#tarif').css('display', 'block');
                $('.numbillet' + id).css('display', 'block').html('billet n° ' + id);
                $('.tarif' + id).css('display', 'block').html(tarif);
                $('.montant' + id).css('display', 'block').html(montant + '<span style="float: right;">€');
            } else {
                //calcul age
                var today = new Date();
                var dayDiff = Math.ceil(today - dob) / (1000 * 60 * 60 * 24 * 365);
                var age = parseInt(dayDiff);
                //get tarif
                if (age <= 12) var montant = 8;
                else if (age > 12 && age < 60) var montant = 16;
                else var montant = 12;
                $('#montant' + id).val(montant);
                //get motif
                if (age <= 12) var tarif = 'enfant';
                else if (age > 12 && age < 60) var tarif = 'normal';
                else var tarif = 'senior';
                $('#motif' + id).val(tarif);
                //append tarif value
                $('#tarif').css('display', 'block');
                $('.numbillet' + id).css('display', 'block').html('billet n° ' + id);
                $('.tarif' + id).css('display', 'block').html(tarif);
                $('.montant' + id).css('display', 'block').html(montant + '<span style="float: right;">€');
            }
        }

        function validInput($string){
            if($string != '' && $string != undefined && $string.trim()){
                if (isLetter($string) == true){
                    return true;
                }
                return 'Valeur non valide';
            }
            return 'Champ obligatoire';
        }

        function isLetter(str) {
            if(str.match(/^([a-zA-Z_ \u00C0-\u00ff]+)$/i)) {
                return true;
            }
            return false;
        }

        function isTarifValid(date_val, check_val){
            if((date_val == '' || date_val == undefined) && check_val == false){
                return 'Champ obligatoire'
            }
            return true;
        }

        $('#btnPaiement').click(function () {
            $('#billet').fadeIn(1000).css("display", "none");
            $("#paiement_info").fadeOut(1000).css("display", "block");
            $("#valider").fadeOut(1000).css("display", "block");
        });

        $(document).on('mousedown', "#billet", function (e) {
            var $name = e.target.name;

            var id_selector = e.target.id;
            $(".validate").keyup(function () {
                $(".error-field").html("");
            });
            $('.obligatoiretarif'+id_selector).html('');
            //$('#' + id_selector).attr('focus', 'geolocate');
            $('input[name="datenaissance' + id_selector + '"]').datepicker({
                autoclose: true,
                startDate: "-100y",
                endDate: "-1y",
                format: "dd-mm-yyyy",
                language: 'fr',
                orientation: "bottom"
            });
            $('input[name="datenaissance' + id_selector + '"]').on('changeDate', function (data) {
                var fullDate = data.date;
                dateDiff(fullDate, id_selector);
                //$('.obligatoiretarif'+id_selector).html('');
                $('#montant_total').html(getTotal(localStorage.getItem('_nbr')) + '<span style="float: right;">€');
                $('input[name="montant_total"]').val(getTotal(localStorage.getItem('_nbr')));
            });

            $('input[name="tarif_reduit' + id_selector + '"]').on('click', function (e) {
                var defaultDate = $('input[name="datenaissance' + id_selector + '"]').val();
                var mydate = new Date(defaultDate);
                if (e.target.checked == true) {
                    dateDiff('reduit', id_selector);
                    $('#montant_total').html(getTotal(localStorage.getItem('_nbr')) + '<span style="float: right;">€');
                    $('input[name="montant_total"]').val(getTotal(localStorage.getItem('_nbr')));
                    $('p#nonreduit' + id_selector).css('display', 'none');
                    $('p#reduit' + id_selector).css('display', 'block');
                } else {
                    if (defaultDate != '') {
                        dateDiff(mydate, id_selector);
                    }else{
                        $('#montant' + id_selector).val('0');
                        $('.montant' + id_selector).css('display', 'none');
                        $('.numbillet' + id_selector).css('display', 'none');
                        $('.tarif' + id_selector).css('display', 'none');
                    }
                    $('#montant_total').html(getTotal(localStorage.getItem('_nbr')) + '<span style="float: right;">€');
                    $('input[name="montant_total"]').val(getTotal(localStorage.getItem('_nbr')));
                    $('p#reduit' + id_selector).css('display', 'none');
                    $('p#nonreduit' + id_selector).css('display', 'block');
                }
            });

            $('input[name="pays' + id_selector + '"]').on('click', function () {
                var options = [
                    "Afghanistan",
                    "Afrique du Sud",
                    "Albanie",
                    "Algérie",
                    "Allemagne",
                    "Andorre",
                    "Angola",
                    "Anguilla",
                    "Antarctique",
                    "Antigua-et-Barbuda",
                    "Antilles néerlandaises",
                    "Arabie saoudite",
                    "Argentine",
                    "Arménie",
                    "Aruba",
                    "Australie",
                    "Autriche",
                    "Azerbaïdjan",
                    "Bahamas",
                    "Bahreïn",
                    "Bangladesh",
                    "Barbade",
                    "Bélarus",
                    "Belgique",
                    "Belize",
                    "Bénin",
                    "Bermudes",
                    "Bhoutan",
                    "Bolivie",
                    "Bosnie-Herzégovine",
                    "Botswana",
                    "Brésil",
                    "Brunéi Darussalam",
                    "Bulgarie",
                    "Burkina Faso",
                    "Burundi",
                    "Cambodge",
                    "Cameroun",
                    "Canada",
                    "Cap-Vert",
                    "Ceuta et Melilla",
                    "Chili",
                    "Chine",
                    "Chypre",
                    "Colombie",
                    "Comores",
                    "Congo-Brazzaville",
                    "Corée du Nord",
                    "Corée du Sud",
                    "Costa Rica",
                    "Côte d’Ivoire",
                    "Croatie",
                    "Cuba",
                    "Danemark",
                    "Diego Garcia",
                    "Djibouti",
                    "Dominique",
                    "Égypte",
                    "El Salvador",
                    "Émirats arabes unis",
                    "Équateur",
                    "Érythrée",
                    "Espagne",
                    "Estonie",
                    "État de la Cité du Vatican",
                    "États fédérés de Micronésie",
                    "États-Unis",
                    "Éthiopie",
                    "Fidji",
                    "Finlande",
                    "France",
                    "Gabon",
                    "Gambie",
                    "Géorgie",
                    "Géorgie du Sud et les îles Sandwich du Sud",
                    "Ghana",
                    "Gibraltar",
                    "Grèce",
                    "Grenade",
                    "Groenland",
                    "Guadeloupe",
                    "Guam",
                    "Guatemala",
                    "Guernesey",
                    "Guinée",
                    "Guinée équatoriale",
                    "Guinée-Bissau",
                    "Guyana",
                    "Guyane française",
                    "Haïti",
                    "Honduras",
                    "Hongrie",
                    "Île Bouvet",
                    "Île Christmas",
                    "Île Clipperton",
                    "Île de l'Ascension",
                    "Île de Man",
                    "Île Norfolk",
                    "Îles Åland",
                    "Îles Caïmans",
                    "Îles Canaries",
                    "Îles Cocos - Keeling",
                    "Îles Cook",
                    "Îles Féroé",
                    "Îles Heard et MacDonald",
                    "Îles Malouines",
                    "Îles Mariannes du Nord",
                    "Îles Marshall",
                    "Îles Mineures Éloignées des États-Unis",
                    "Îles Salomon",
                    "Îles Turks et Caïques",
                    "Îles Vierges britanniques",
                    "Îles Vierges des États-Unis",
                    "Inde",
                    "Indonésie",
                    "Irak",
                    "Iran",
                    "Irlande",
                    "Islande",
                    "Israël",
                    "Italie",
                    "Jamaïque",
                    "Japon",
                    "Jersey",
                    "Jordanie",
                    "Kazakhstan",
                    "Kenya",
                    "Kirghizistan",
                    "Kiribati",
                    "Koweït",
                    "Laos",
                    "Lesotho",
                    "Lettonie",
                    "Liban",
                    "Libéria",
                    "Libye",
                    "Liechtenstein",
                    "Lituanie",
                    "Luxembourg",
                    "Macédoine",
                    "Madagascar",
                    "Malaisie",
                    "Malawi",
                    "Maldives",
                    "Mali",
                    "Malte",
                    "Maroc",
                    "Martinique",
                    "Maurice",
                    "Mauritanie",
                    "Mayotte",
                    "Mexique",
                    "Moldavie",
                    "Monaco",
                    "Mongolie",
                    "Monténégro",
                    "Montserrat",
                    "Mozambique",
                    "Myanmar",
                    "Namibie",
                    "Nauru",
                    "Népal",
                    "Nicaragua",
                    "Niger",
                    "Nigéria",
                    "Niue",
                    "Norvège",
                    "Nouvelle-Calédonie",
                    "Nouvelle-Zélande",
                    "Oman",
                    "Ouganda",
                    "Ouzbékistan",
                    "Pakistan",
                    "Palaos",
                    "Panama",
                    "Papouasie-Nouvelle-Guinée",
                    "Paraguay",
                    "Pays-Bas",
                    "Pérou",
                    "Philippines",
                    "Pitcairn",
                    "Pologne",
                    "Polynésie française",
                    "Porto Rico",
                    "Portugal",
                    "Qatar",
                    "R.A.S. chinoise de Hong Kong",
                    "R.A.S. chinoise de Macao",
                    "régions éloignées de l’Océanie",
                    "République centrafricaine",
                    "République démocratique du Congo",
                    "République dominicaine",
                    "République tchèque",
                    "Réunion",
                    "Roumanie",
                    "Royaume-Uni",
                    "Russie",
                    "Rwanda",
                    "Sahara occidental",
                    "Saint-Barthélémy",
                    "Saint-Kitts-et-Nevis",
                    "Saint-Marin",
                    "Saint-Martin",
                    "Saint-Pierre-et-Miquelon",
                    "Saint-Vincent-et-les Grenadines",
                    "Sainte-Hélène",
                    "Sainte-Lucie",
                    "Samoa",
                    "Samoa américaines",
                    "Sao Tomé-et-Principe",
                    "Sénégal",
                    "Serbie",
                    "Serbie-et-Monténégro",
                    "Seychelles",
                    "Sierra Leone",
                    "Singapour",
                    "Slovaquie",
                    "Slovénie",
                    "Somalie",
                    "Soudan",
                    "Sri Lanka",
                    "Suède",
                    "Suisse",
                    "Suri'name'",
                    "Svalbard et Île Jan Mayen",
                    "Swaziland",
                    "Syrie",
                    "Tadjikistan",
                    "Taïwan",
                    "Tanzanie",
                    "Tchad",
                    "Terres australes françaises",
                    "Territoire britannique de l'océan Indien",
                    "Territoire palestinien",
                    "Thaïlande",
                    "Timor oriental",
                    "Togo",
                    "Tokelau",
                    "Tonga",
                    "Trinité-et-Tobago",
                    "Tristan da Cunha",
                    "Tunisie",
                    "Turkménistan",
                    "Turquie",
                    "Tuvalu",
                    "Ukraine",
                    "Union européenne",
                    "Uruguay",
                    "Vanuatu",
                    "Venezuela",
                    "Viêt Nam",
                    "Wallis-et-Futuna",
                    "Yémen",
                    "Zambie",
                    "Zimbabwe"
                ];
                $(".recherche").autocomplete({
                    source: options
                });
            });
        });

        /*Payement*/
        $(document).on('click', "#strippay", function (e) {
            for (var i = 1; i <= localStorage.getItem('_nbr'); i++) {
                var isNom = false;
                var isPrenom = false;
                var isPays = false;
                var isTarif = false;

                // Nom
                if (validInput($('input[name="nom' + i + '"]').val()) == true) {
                    isNom = true;
                } else {
                    isNom = false;
                    $(".obligatoirenom" + i).html(validInput($('input[name="nom' + i + '"]').val()));
                }

                // Prenom
                if (validInput($('input[name="prenom' + i + '"]').val()) == true) {
                    isPrenom = true;
                } else {
                    isPrenom = false;
                    $(".obligatoireprenom" + i).html(validInput($('input[name="prenom' + i + '"]').val()));
                }

                //Pays
                if (validInput($('input[name="pays' + i + '"]').val()) == true) {
                    isPays = true;
                } else {
                    isPays = false;
                    $(".obligatoirepays" + i).html(validInput($('input[name="pays' + i + '"]').val()));
                }

                //Tarif
                if (isTarifValid($('input[name="datenaissance' + i + '"]').val(), $('input[name="tarif_reduit' + i + '"]').is(":checked")) == true) {
                    isTarif = true;
                } else {
                    isTarif = false;
                    $(".obligatoiretarif" + i).html(isTarifValid($('input[name="datenaissance' + i + '"]').val(), $('input[name="tarif_reduit' + i + '"]').is(":checked")));
                }
            }

            if (isNom == true && isPrenom == true && isPays == true && isTarif == true) {
                $("#billet").fadeOut(1000).css("display", "none");
                $("#tarrifs_details").fadeOut(1000).css("display", "none");
                $("#paiement_info").fadeIn(1000).css("display", "block");
                $("#validate_all").fadeIn(1000).css("display", "block");
            }
        });
    </script>

    <!-- script pour la partie stripe form -->
    <script type="text/javascript">
        //get stripe info
        Stripe.setPublishableKey('{{ container.parameter('stripe_public_key') }}');

        var $_form = $('#payment-form');
        $('input[name="emailclient"]').on('keydown',function (e) {
            $('#emailclient').html('');
        });
        $('input[name="nomclient"]').on('keydown',function (e) {
            $('#nomclient').html('');
        });
        $('input[name="cvc"]').on('keydown',function (e) {
            $('#cvc').html('');
        });
        $_form.submit(function (e) {
            e.preventDefault();
            $_form.find('button').prop('disabled', true);
            if($('input[name="emailclient"]').val() == '' || $('input[name="nomclient"]').val() == '' || $('input[name="cvc"]').val() == ''){
                $_form.find('button').prop('disabled', false);
                if(isValidEmail($('input[name="emailclient"]').val()) == true){
                    $('#emailclient').html('');
                }else{
                    $('#emailclient').html(isValidEmail($('input[name="emailclient"]').val()));
                }
                if(validInput($('input[name="nomclient"]').val()) == true){
                    $('#nomclient').html('');
                }else{
                    $('#nomclient').html(validInput($('input[name="nomclient"]').val()));
                }
                if($('input[name="cvc"]').val() == ''){
                    $('#cvc').html('Champ obligatoire');
                }else{
                    $('#cvc').html('');
                }
            }else{
                $("#loading_pay").fadeIn(1000).css("display", "block");
                $('#nomclient').html('');
                $('#emailclient').html('');
                $('#cvc').html('');
                Stripe.card.createToken($_form,function (status, response) {
                    $("#loading_pay").fadeIn(1000).css("display", "block");
                    if(response.error){
                        $("#loading_pay").fadeIn(1000).css("display", "none");
                        $_form.find('button').prop('disabled', false);
                        $('#card_error').html('');
                        $('#exp_month').html('');
                        if(response.error.type == "card_error" && response.error.param == "number") $('#card_error').html('Votre numéro de carte est invalide');
                        if(response.error.type == "invalid_request_error") {
                            $('#exp_month').html('');
                            $('#card_error').html('Veuillez saisir votre numéro de carte');
                        }
                        if(response.error.type == "card_error" && response.error.param == "exp_month") $('#exp_month').html('Votre carte n\'est plus valide');
                        if(response.error.type == "card_error" && response.error.param == "cvc") $('#cvc').html('Code cvc invalide');
                        //$_form.find('.payment-errors').text(response.error.message);
                    }else{
                        $("#loading_pay").fadeIn(1000).css("display", "block");
                        $_form.find('#card_error').html();
                        $('#card_error').html('');
                        $('#exp_month').html('');
                        $('#cvc').html('');
                        var _token = response.id;
                        $_form.append('<input type="hidden" name="stripeToken" value="'+_token+'" />');
                        $_form.get(0).submit();
                    }
                })
            }
        });

        function validInput($string){
            if($string != '' && $string != undefined && $string.trim()){
                if (isLetter($string) == true){
                    return true;
                }
                return 'Valeur non valide';
            }
            return 'Champ obligatoire';
        }

        function isLetter(str) {
            if(str.match(/^([a-zA-Z_ \u00C0-\u00ff]+)$/i)) {
                return true;
            }
            return false;
        }

        function isValidEmail(email_cli) {
            if(email_cli != '' && email_cli != undefined){
                var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
                if(pattern.test(email_cli) == true){
                    return true;
                }
                return 'Format non valide';
            }
            return 'Champ obligatoire';
        }
    </script>
{% endblock %}